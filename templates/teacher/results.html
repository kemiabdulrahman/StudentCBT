{% extends "base.html" %}

{% block title %}Results - CBT System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Exam Results</h1>
            <p class="text-gray-600 mt-2">View and manage exam results</p>
        </div>
    </div>

    {% if results %}
    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-clipboard-list text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Total Results</p>
                    <p class="text-2xl font-bold text-gray-800">{{ results|length }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Published</p>
                    <p class="text-2xl font-bold text-gray-800">{{ results|selectattr('published', 'equalto', True)|list|length }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-clock text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Pending</p>
                    <p class="text-2xl font-bold text-gray-800">{{ results|selectattr('published', 'equalto', False)|list|length }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-percentage text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Avg Score</p>
                    {% set avg = results|map(attribute='percentage')|sum / results|length if results|length > 0 else 0 %}
                    <p class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(avg) }}%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter/Search Section -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="searchInput" placeholder="Search by student name or exam..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="min-w-[150px]">
                <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="published">Published</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="min-w-[150px]">
                <select id="gradeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Grades</option>
                    <option value="A">Grade A</option>
                    <option value="B">Grade B</option>
                    <option value="C">Grade C</option>
                    <option value="D">Grade D</option>
                    <option value="F">Grade F</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exam</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="resultsTableBody">
                {% for result in results %}
                <tr class="hover:bg-gray-50 result-row" 
                    data-student="{{ result.attempt.student.full_name|lower }}" 
                    data-exam="{{ result.attempt.exam.title|lower }}"
                    data-status="{{ 'published' if result.published else 'pending' }}"
                    data-grade="{{ result.grade }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                {{ result.attempt.student.first_name[0] }}{{ result.attempt.student.last_name[0] }}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ result.attempt.student.full_name }}</div>
                                <div class="text-sm text-gray-500">{{ result.attempt.student.student_id }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">{{ result.attempt.exam.title }}</div>
                        <div class="text-sm text-gray-500">{{ result.attempt.exam.subject.name }} - {{ result.attempt.exam.school_class.name }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ result.marks_obtained }}/{{ result.total_marks }}</div>
                        <div class="text-sm text-gray-500">{{ "%.1f"|format(result.percentage) }}%</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full
                            {% if result.grade == 'A' %}bg-green-100 text-green-800
                            {% elif result.grade == 'B' %}bg-blue-100 text-blue-800
                            {% elif result.grade == 'C' %}bg-yellow-100 text-yellow-800
                            {% elif result.grade == 'D' %}bg-orange-100 text-orange-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ result.grade }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if result.published %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-check mr-1"></i>Published
                        </span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            <i class="fas fa-clock mr-1"></i>Pending
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ result.created_at.strftime('%b %d, %Y') }}</div>
                        <div class="text-sm text-gray-500">{{ result.created_at.strftime('%I:%M %p') }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ url_for('teacher.result_details', result_id=result.id) }}" 
                           class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-eye mr-1"></i>View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="noResults" class="hidden bg-white rounded-lg shadow p-12 text-center mt-6">
        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">No Results Found</h3>
        <p class="text-gray-500">Try adjusting your search or filter criteria</p>
    </div>

    {% else %}
    <div class="bg-white rounded-lg shadow p-12 text-center">
        <i class="fas fa-chart-bar text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">No Results Yet</h3>
        <p class="text-gray-500">Results will appear here once exams are graded</p>
    </div>
    {% endif %}
</div>

<style>
    .hover\:bg-gray-50:hover {
        transition: background-color 0.2s ease;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const gradeFilter = document.getElementById('gradeFilter');
    const tableBody = document.getElementById('resultsTableBody');
    const noResults = document.getElementById('noResults');
    const rows = document.querySelectorAll('.result-row');

    function filterResults() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const gradeValue = gradeFilter.value;
        let visibleCount = 0;

        rows.forEach(row => {
            const student = row.dataset.student;
            const exam = row.dataset.exam;
            const status = row.dataset.status;
            const grade = row.dataset.grade;

            const matchesSearch = student.includes(searchTerm) || exam.includes(searchTerm);
            const matchesStatus = !statusValue || status === statusValue;
            const matchesGrade = !gradeValue || grade === gradeValue;

            if (matchesSearch && matchesStatus && matchesGrade) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        if (tableBody) {
            tableBody.parentElement.parentElement.style.display = visibleCount > 0 ? '' : 'none';
        }
        if (noResults) {
            noResults.style.display = visibleCount > 0 ? 'none' : 'block';
        }
    }

    if (searchInput) searchInput.addEventListener('input', filterResults);
    if (statusFilter) statusFilter.addEventListener('change', filterResults);
    if (gradeFilter) gradeFilter.addEventListener('change', filterResults);
});
</script>
{% endblock %}