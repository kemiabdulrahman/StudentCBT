{% extends "base.html" %}

{% block title %}{{ exam.title }} - Exam Info{% endblock %}

{% block content %}
<div class="mb-8">
    <a href="{{ url_for('student.exams') }}" class="text-blue-600 hover:text-blue-800 mb-4 inline-block">
        <i class="fas fa-arrow-left mr-2"></i>Back to Exams
    </a>

    <h1 class="text-3xl font-bold text-gray-800">{{ exam.title }}</h1>
    <p class="text-gray-600 mt-2">Total Marks: {{ exam.total_marks }}</p>

    {% if exam.scheduled_start and exam.scheduled_end %}
    {% set start_local = exam.scheduled_start.replace(tzinfo=ZoneInfo('UTC')).astimezone(ZoneInfo('Africa/Lagos')) %}
    {% set end_local = exam.scheduled_end.replace(tzinfo=ZoneInfo('UTC')).astimezone(ZoneInfo('Africa/Lagos')) %}
    <p class="text-gray-600 mt-1">
        Scheduled: 
        {{ start_local.strftime('%b %d, %Y %H:%M') }}
         - 
        {{ end_local.strftime('%b %d, %Y %H:%M') }}
        (Nigeria Time)
    </p>
    {% else %}
    <p class="text-gray-600 mt-1">Scheduled: Anytime</p>
    {% endif %}

    <p class="text-gray-600 mt-1">
        Attempts Allowed: {{ 'Unlimited' if exam.allow_multiple_attempts else '1' }}
        {% if exam.allow_multiple_attempts %}(Max {{ exam.max_attempts }}){% endif %}
    </p>
</div>

<!-- Countdown Timer -->
{% if exam.scheduled_start and exam.scheduled_end %}
<div id="countdown" class="text-lg font-semibold text-red-600 mb-4"></div>
{% endif %}

<!-- Check if there's an in-progress attempt -->
{% set in_progress = previous_attempts | selectattr('status', 'equalto', 'in_progress') | list %}

<!-- Previous Attempts -->
{% if previous_attempts %}
<div class="mb-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-3">Your Previous Attempts</h2>
    <div class="space-y-3">
        {% for attempt in previous_attempts %}
        <div class="bg-gray-50 border-l-4 
            {% if attempt.status == 'in_progress' %}border-yellow-500{% else %}border-blue-500{% endif %} 
            p-4 rounded shadow-sm flex justify-between items-center">
            <div>
                <p class="text-gray-800 font-medium">
                    Attempt #{{ attempt.attempt_number }} on {{ attempt.started_at.strftime('%b %d, %Y %H:%M') }}
                    {% if attempt.status == 'in_progress' %}
                        <span class="text-yellow-600 font-semibold">(In Progress)</span>
                    {% endif %}
                </p>
                <p class="text-gray-600 text-sm">
                    {% if attempt.status == 'in_progress' %}
                        Status: Not submitted yet
                    {% else %}
                        Score: {{ attempt.total_score }}/{{ exam.total_marks }} 
                        {% if attempt.status == 'graded' %}(Graded){% elif attempt.status == 'submitted' %}(Awaiting grading){% endif %}
                    {% endif %}
                </p>
            </div>
            {% if attempt.status == 'in_progress' %}
            <a href="{{ url_for('student.take_exam', attempt_id=attempt.id) }}" 
               class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-6 rounded font-semibold">
                <i class="fas fa-play mr-2"></i>Resume
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Start Exam Button - only show if no in-progress attempt -->
{% if in_progress %}
    <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
        <p class="text-yellow-800 font-semibold">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            You have an exam in progress. Please resume it above or it will be auto-submitted when time expires.
        </p>
    </div>
{% elif can_attempt and is_available %}
    <div class="mt-6">
        <form method="POST" action="{{ url_for('student.start_exam', exam_id=exam.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold text-lg">
                <i class="fas fa-play mr-2"></i>Start Exam
            </button>
        </form>
    </div>
{% elif not is_available %}
    <div class="mt-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
        <p class="text-red-800 font-semibold">
            <i class="fas fa-clock mr-2"></i>
            This exam is not currently available.
        </p>
    </div>
{% else %}
    <div class="mt-6 bg-gray-50 border-l-4 border-gray-500 p-4 rounded">
        <p class="text-gray-700 font-semibold">
            <i class="fas fa-ban mr-2"></i>
            You have reached the maximum number of attempts for this exam.
        </p>
    </div>
{% endif %}

{% endblock %}

{% block scripts %}
{% if exam.scheduled_start and exam.scheduled_end %}
<script>
// Get exam times from server
const startTime = new Date("{{ exam.scheduled_start.isoformat() }}");
const endTime = new Date("{{ exam.scheduled_end.isoformat() }}");

function updateCountdown() {
    const now = new Date();
    let text = "";
    
    if (now < startTime) {
        const diff = startTime - now;
        const hours = Math.floor(diff / 1000 / 60 / 60);
        const minutes = Math.floor(diff / 1000 / 60) % 60;
        const seconds = Math.floor(diff / 1000) % 60;
        text = `Exam starts in ${hours}h ${minutes}m ${seconds}s`;
    } else if (now >= startTime && now <= endTime) {
        const diff = endTime - now;
        const hours = Math.floor(diff / 1000 / 60 / 60);
        const minutes = Math.floor(diff / 1000 / 60) % 60;
        const seconds = Math.floor(diff / 1000) % 60;
        text = `Exam ends in ${hours}h ${minutes}m ${seconds}s`;
    } else {
        text = "Exam has ended.";
    }
    
    document.getElementById("countdown").innerText = text;
}

setInterval(updateCountdown, 1000);
updateCountdown();
</script>
{% endif %}
{% endblock %}